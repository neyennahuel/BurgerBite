const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT8eU89XL7ucxbUaggrjgyWlnT6oDKMGRCL6SO7ywbM-ObzBueYGiVtYMHUx7PJ1fqJIrcrcuGcTG2g/pub?gid=0&single=true&output=csv";
const DEFAULT_IMAGE = "img/default.jpg";
const WHATSAPP_NUMBER = "5492634546537";
const CART_KEY = "burgerbite_cart";

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
    fetch(CSV_URL)
        .then(res => res.text())
        .then(text => {
            renderMenu(parseCSV(text));
            initWhatsappButton();
        })
        .catch(() => alert("No se pudo cargar la carta."));
});

/* ================= CSV ================= */
function parseCSV(text) {
    const rows = [];
    let row = [];
    let current = "";
    let inQuotes = false;

    for (let char of text) {
        if (char === '"') inQuotes = !inQuotes;
        else if (char === "," && !inQuotes) {
            row.push(current.trim());
            current = "";
        } else if ((char === "\n" || char === "\r") && !inQuotes) {
            if (current || row.length) rows.push([...row, current.trim()]);
            row = [];
            current = "";
        } else current += char;
    }

    if (current || row.length) rows.push([...row, current.trim()]);

    const headers = rows.shift();
    return rows.map(cols =>
        Object.fromEntries(headers.map((h, i) => [h.trim(), cols[i] || ""]))
    );
}

/* ================= HELPERS ================= */
const normalize = t =>
    t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

const driveToImageUrl = url =>
    !url ? DEFAULT_IMAGE :
    url.includes("lh3.googleusercontent.com") ? url :
    url.includes("id=") ? `https://lh3.googleusercontent.com/d/${url.split("id=")[1]}` :
    url;

/* ================= CART ================= */
const getCart = () => JSON.parse(localStorage.getItem(CART_KEY)) || {};
const saveCart = cart => localStorage.setItem(CART_KEY, JSON.stringify(cart));

function updateCart(item, delta) {
    const cart = getCart();
    cart[item.Nombre] ??= { nombre: item.Nombre, precio: +item.Precio, cantidad: 0 };
    cart[item.Nombre].cantidad += delta;
    if (cart[item.Nombre].cantidad <= 0) delete cart[item.Nombre];
    saveCart(cart);
    return cart[item.Nombre]?.cantidad || 0;
}

/* ================= RENDER ================= */
function renderMenu(items) {
    const cart = getCart();

    items.forEach(item => {
        if (item.Disponible !== "TRUE") return;

        const contenedor = document.querySelector(`#${normalize(item.Categoria)} .productos`);
        if (!contenedor) return;

        const producto = document.createElement("div");
        producto.className = "producto";

        producto.innerHTML = `
            <img src="${driveToImageUrl(item.Imagen)}" alt="${item.Nombre}">
            <div class="info">
                <h3>${item.Nombre}</h3>
                <p>${item.Descripcion}</p>
                <span class="precio">$${item.Precio}</span>
                <div class="cantidad-control">
                    <button class="menos">âˆ’</button>
                    <span class="cantidad">${cart[item.Nombre]?.cantidad || 0}</span>
                    <button class="mas">+</button>
                </div>
            </div>
        `;

        const span = producto.querySelector(".cantidad");
        producto.querySelector(".mas").onclick = () => span.textContent = updateCart(item, 1);
        producto.querySelector(".menos").onclick = () => span.textContent = updateCart(item, -1);

        contenedor.appendChild(producto);
    });
}

/* ================= WHATSAPP ================= */
function initWhatsappButton() {
    const modal = document.getElementById("deliveryModal");
    const btnWA = document.querySelector(".whatsapp-float");

    btnWA.onclick = e => {
        e.preventDefault();
        if (!Object.keys(getCart()).length) return alert("No agregaste productos.");
        modal.classList.add("active");
        document.body.classList.add("modal-open");
    };

    document.getElementById("btnDelivery").onclick = () => enviarPedido("Con delivery");
    document.getElementById("btnTakeAway").onclick = () => enviarPedido("Take away");
}

function enviarPedido(tipoEntrega) {
    const items = Object.values(getCart());
    let total = 0;
    let detalle = "";

    items.forEach(i => {
        total += i.precio * i.cantidad;
        detalle += `â€¢ ${i.cantidad} x ${i.nombre}\n`;
    });

    const mensaje = `
Hola ðŸ‘‹
QuerÃ­a hacer el siguiente pedido:

${detalle}
Total: $${total}
Entrega: ${tipoEntrega}
`.trim();

    localStorage.removeItem(CART_KEY);
    window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(mensaje)}`;
}
